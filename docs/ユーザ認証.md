
# ユーザ認証機能仕様書

## 概要
ユーザ認証機能は、メールアドレスとパスワードを用いてユーザを認証し、セキュアなセッションを確立することを目的としています。この機能は、不正アクセス防止やユーザデータ保護のための基盤機能です。

---

## 機能要件

### 1. **新規登録**
ユーザが初めてアカウントを作成する際に必要な処理を定義します。

#### 必要な情報
- メールアドレス
- パスワード（ハッシュ化される）
- ユーザ名（任意）
- 登録日時（自動生成）

#### バリデーション
- メールアドレスは有効な形式であること。
- パスワードは8文字以上、英数字を含むこと。
- メールアドレスの重複を許可しない（ユニーク制約）。

#### 処理フロー
1. クライアントから必要な情報を受け取る。
2. メールアドレスの形式とパスワードの強度を検証。
3. データベースに新しいユーザを登録。
4. 成功時に登録完了メッセージを返す。

---

### 2. **ログイン**
既存ユーザがシステムにアクセスするための認証処理を定義します。

#### 必要な情報
- メールアドレス
- パスワード

#### バリデーション
- メールアドレスが登録済みであること。
- パスワードが正しいこと。

#### 処理フロー
1. クライアントから認証情報を受け取る。
2. データベースで該当するメールアドレスを検索。
3. 入力されたパスワードをハッシュ化し、保存されたパスワードと比較。
4. 認証成功時にJWTトークンを発行して返す。

#### エラーハンドリング
- メールアドレスが登録されていない場合、エラーメッセージを返す。
- パスワードが間違っている場合、エラーメッセージを返す。

---

### 3. **ログアウト**
セッションを終了し、発行されたトークンを無効化します。

#### 必要な情報
- 現在のセッションのJWTトークン

#### 処理フロー
1. クライアントからログアウトリクエストを受け取る。
2. サーバサイドでトークンをブラックリストに登録（オプション）。
3. ログアウト成功メッセージを返す。

---

## APIエンドポイント定義

### 1. **新規登録**
- **エンドポイント**: `POST /auth/register`
- **リクエスト例**
  ```json
  {
      "email": "example@example.com",
      "password": "securePassword123",
      "username": "exampleUser"
  }
  ```
- **レスポンス例**
  ```json
  {
      "message": "User registered successfully"
  }
  ```

### 2. **ログイン**
- **エンドポイント**: `POST /auth/login`
- **リクエスト例**
  ```json
  {
      "email": "example@example.com",
      "password": "securePassword123"
  }
  ```
- **レスポンス例**
  ```json
  {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
  ```

### 3. **ログアウト**
- **エンドポイント**: `POST /auth/logout`
- **リクエスト例**
  ```json
  {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
  ```
- **レスポンス例**
  ```json
  {
      "message": "Logged out successfully"
  }
  ```

---

## セキュリティ要件

1. **パスワードのハッシュ化**
   - bcryptなどのアルゴリズムを使用。
   - ハッシュ化されたパスワードをデータベースに保存。

2. **トークン認証**
   - JWT（JSON Web Token）を使用。
   - トークンには有効期限を設定（例: 1時間）。

3. **トークンのセキュリティ**
   - HTTPS通信を強制。
   - トークンのペイロードには機密情報を含めない。

4. **レート制限**
   - 多数のログイン試行を検知してブロック（例: 5回失敗で1時間ブロック）。

5. **ブラックリスト機能**
   - ログアウト時にトークンをブラックリストに登録し、以降の使用を無効化。

---

## データベース設計

### ユーザテーブル
| カラム名      | 型          | 制約                     |
|---------------|-------------|--------------------------|
| id            | UUID        | プライマリキー           |
| email         | VARCHAR(255)| ユニーク制約             |
| password      | VARCHAR(255)| ハッシュ化済み           |
| username      | VARCHAR(50) | NULL許可（任意）         |
| created_at    | TIMESTAMP   | 自動生成                 |
| updated_at    | TIMESTAMP   | 自動生成                 |

### ブラックリストトークンテーブル（オプション）
| カラム名      | 型          | 制約                     |
|---------------|-------------|--------------------------|
| id            | UUID        | プライマリキー           |
| token         | TEXT        | トークン文字列           |
| created_at    | TIMESTAMP   | 自動生成                 |

---

## 今後の拡張案
- ソーシャルログイン（Google, Facebook, Twitterなど）。
- 多要素認証（MFA）の導入。
- アカウントロック機能（複数回ログイン失敗時）。
- ユーザのパスワード変更機能。

